# ドメインモデリング

## 参考

[ドメインモデリング](https://zenn.dev/yamachan0625/books/ddd-hands-on/viewer/chapter4_domain_modeling)

## コアドメイン、サブドメインの特定

> コアドメインとは、各ビジネスが持つ最も重要な価値や競争優位性を生み出す部分を指します。これは、ビジネスの中心的なミッションや戦略に直結しています。

> サブドメインとは、ビジネスの主要な業務領域をサポートする部分を指します。これは通常、コアドメインを補完する形で存在します。サブドメインは一般的に、汎用サブドメインと支援サブドメインの 2 種類に分けられます。汎用サブドメインは全体で共通の機能 (認証機能など) を持ち、支援サブドメインはコアドメインをサポートするような機能を持っています

### コアドメイン

**トリガーを使用したシュミレーション対戦**

ワールドトリガーの漫画内で登場したシミュレーションゲームのように、行動の設定と行動の実行を繰り返して対戦を行います

### サブドメイン

#### 汎用サブドメイン

1. **プレイヤー情報の管理**

    プレイヤーが希望する場合、プレイヤーIDとMFA認証を登録できます。

2. **プレイヤー認証**

    登録されたプレイヤーIDとMFA認証を使用して、プレイヤーの認証を行います。

#### 支援サブドメイン

1. **対戦相手のマッチング**

    最初に入室したプレイヤーを待機状態とし、2 人目以降のプレイヤーが入室した際に待機中のプレイヤーとマッチングを行います

2. **対戦の中断**

    対戦中にプレイヤーが退室した場合、対戦を中断し、残りのプレイヤーに対戦中断の通知を行います

## エンティティの特定

エンティティとは、システム内の重要なオブジェクトで、一意の識別子によって識別され、変更可能な状態を持つものです。

### ビジネス要件の確認

#### 対戦の概要についての要件

* 1つの試合は20分程度にする
* プレイヤーは出撃するユニットを選択できる
* ユニットの種類ごとに固有のパラメータが割り振られる
* パラメータの種類は以下とする
    * 行動力
    * トリオン
    * 攻撃
    * 防御
    * 回避
    * 援護
    * 技術

* MAP上で敵味方がユニットを動かす形で進行する
* お互い150秒間ですべてのユニットの動きを設定する
* その設定に従ってすべてのユニットが15秒間で一斉に行動する
* **動きの設定**と**ユニットの行動**を1ターンとする
* 1試合は6ターンで終了する
* 試合終了時に生き残ったユニット数に2体以上の差が付けばユニット数が多いチームの勝利となる
* ユニット数の差が2体未満の場合、引き分けとする

#### ユニットの行動についての要件

* ユニットの行動力はそのユニットが1ターンにどれだけ行動できるかを示す
* MAP上を1マス移動するとき行動力を1消費する
* 攻撃や防御などもトリガーごとに決められた行動力を消費する
* トリガーごとに決まった待機時間を持つ
* 全ユニットが行動力を使い切るとターン終了

#### 視界についての要件

* ユニットの視界の範囲のマスは白で表示する
* 視界外のマスはグレーで表示する
* 視界内の敵ユニットは通常通り表示する
* 視界外の敵ユニットはシルエットで表示する
* バッグワームを装備しているキャラクターが視界外にいる場合は非表示とする
* マスはそれぞれの高さを持つ
* 高い場所に登ると視界は少し広がる、逆に足元は見えづらくなる

#### 戦闘についての要件

* プレイヤーは以下の行動を選択可能
    * 選択
    * 地点確認
    * 護衛
    * 固有コマンド
    * 移動
    * 追跡移動
    * 待機
* メイントリガーとサブトリガーはそれぞれ4つの装備から使用するトリガーを行動ごとに変更可能
* メインとサブのトリガーを表示する
* トリガーはそれぞれの射程範囲を持つ
* 射程範囲を扇形で表示する
* お互いユニットを動かして射程範囲に敵が入ると、そのトリガーで自動的に攻撃する(コンバット)
* トリガーの射程範囲はカーソルのグリッドで動かすことができる
* シールド/レイガスト/エスクードは扇形の方向だけ防御できる
* シールドなどの防御用トリガー以外でも攻撃を避けるかの判定がある（シールドにもある）
* 扇形以外の方向から攻撃されると回避も防御もできない
* 視界に入っている敵ユニットを自動で追尾する動きも選択できる
* 行動にはそれぞれに決まった待ち時間が存在する

#### トリガーについての要件

| トリガー名 | 能力 | 特殊効果 | 
| --- | --- | --- |
| シールド | | メインとサブの両方を同じ向きに設定するとフルガードとなり防御力50%上昇 |
| カメレオン | | 発動中は自動攻撃の対象にならない |

#### スキルについての要件

| スキル名 | 効果 |
| --- | --- |
| 近接連携 | ユニットAが近接攻撃を行ったあと、ユニットBが同じユニットに攻撃すると、ユニットAが再度追加で攻撃する(行動力の消費なし)　 |
| 射撃連携 | ユニットAが射撃攻撃を行ったあと、ユニットBが同じユニットに攻撃すると、ユニットAが再度追加で攻撃する(行動力は半額)　 |
| グラスホッパー攻撃 | グラスホッパー装備時、攻撃と移動に必要な行動力の消費と待ち時間が半分になる |

### エンティティの識別

エンティティとは、システム内の重要なオブジェクトで、一意の識別子によって識別され、変更可能な状態を持つもの

* プレイヤー (プレイヤーID)
* ユニット (ユニットID)
* マッチング (マッチングID)
* ゲーム (ゲームID)
* ターン (ターンID)
* 行動 (行動ID)
* コンバット (コンバットID)
* マップ (マップID)

### エンティティ間の関連の定義

* プレイヤー は 複数の ユニット を所有する (1対多)
* プレイヤー は 複数の 対戦 に参加する (多対多)
* 対戦 は 複数の ターン を持つ (1対多)
* ターン は 複数の 行動 を持つ (1対多)
* 行動 は　複数の コンバット を持つ (1対多)
* ユニット種別 は 複数の ユニット を持つ (1対多)
* ユニット は 複数の トリガー を持つ (1対多)
* ユニット は 複数の スキル を持つ (1対多)
* 対戦 は 1 つの マップ を持つ (1対1)

### 属性の識別

* プレイヤー
    * プレイヤーID
    * プレイヤー名
    * 登録日時
    * MFA認証情報
* ユニット
    * ユニットID
    * 対戦ID
    * ユニット種別
    * 所有プレイヤーID
    * 現在の行動力
    * 現在の待機時間
    * 現在の位置 (X座標, Y座標)
    * 使用しているメイントリガー
    * 使用しているサブトリガー
    * 装備しているメイントリガー一覧
    * 装備しているサブトリガー一覧
    * メイントリガーHP
    * サブトリガーHP
    * 視界範囲（高さによって変動）
    * 撃墜済みフラグ

* マッチング
    * マッチングID
    * 参加プレイヤー一覧
    * マッチング開始日時
    * マッチング終了日時
    * マッチング状態 (進行中, 中断, 終了)
* ゲーム
    * ゲームID
    * マッチングID
    * 現在のターン数
    * 地図状態
    * ユニット一覧
* ターン結果
    * ターンID
    * 対戦ID
    * ターン番号
    * ターン開始日時
    * ターン終了日時
    * ターン状態（設定中、実行中、完了）
* 行動
    * 行動ID
    * ユニットデータ
    * ターンID
    * 行動タイプ (移動, 攻撃, 待機, 護衛, 固有コマンド, 追跡移動)
* コンバット
    * コンバットID
    * 攻撃ユニットID
    * 防御ユニットID
    * 使用トリガーID
    * ダメージ量
    * 命中判定結果 (命中, 回避, 防御)


### マスターデータの識別

エンティティに近いが、固定値なので変化がないもの。

* ユニット種別
    * 行動力
    * トリオン
    * 攻撃
    * 防御
    * 回避
    * 援護
    * 技術
    * スキル一覧

* トリガー
    * トリガーID
    * トリガー名
    * 消費行動力
    * 待ち時間
    * 基礎威力
    * 基礎命中率
    * 射程
    * 警戒範囲

* スキル
    * スキルID
    * スキル名
    * 効果詳細

* マップ
    * マップID
    * マップ名
    * グリッドサイズ (幅, 高さ)
    * 障害物配置情報

### ビジネスルールの把握

**基本的にビジネス要件に基づく**